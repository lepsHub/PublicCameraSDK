name: Release Pipeline

on:
  pull_request:
    types: [closed]
    branches:
      - "release/*"
  workflow_dispatch:
    inputs:
      cut:
        description: "Release type"
        type: choice
        options: [beta, rc, prod]
      frameworks:
        description: "Frameworks to cut"
        type: choice
        options: [camera, core, all]
      dry_run:
        description: "Dry run"
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: read

jobs:
  prepare:
    uses: ./.github/workflows/prepare-release.yml
    with:
      cut: ${{ github.event.inputs.cut }}
      frameworks: ${{ github.event.inputs.frameworks }}
      dry_run: ${{ github.event.inputs.dry_run }}
      event_name: ${{ github.event_name }}
      event: ${{ toJson(github.event) }}

  build:
    needs: prepare
    if: ${{ needs.prepare.outputs.cut != '' && needs.prepare.outputs.frameworks != '' }}
    uses: ./.github/workflows/build-sdk.yml
    with:
      frameworks: ${{ needs.prepare.outputs.frameworks }}
      cut: ${{ needs.prepare.outputs.cut }}

  publish:
    needs: [prepare, build]
    if: ${{ needs.prepare.outputs.cut != '' && needs.prepare.outputs.frameworks != '' }}
    uses: ./.github/workflows/publish-release.yml
    with:
      cut: ${{ needs.prepare.outputs.cut }}
      frameworks: ${{ needs.prepare.outputs.frameworks }}
      dry_run: ${{ needs.prepare.outputs.dry }}
