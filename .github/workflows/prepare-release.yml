name: Prepare Release
on:
  workflow_call:
    inputs:
      cut:
        type: string
        required: false
      frameworks:
        type: string
        required: false
      dry:
        type: string
        required: false
      event_name:
        type: string
        required: true
      event:
        type: string
        required: true
    outputs:
      cut:
        value: ${{ jobs.prepare.outputs.cut }}
      frameworks:
        value: ${{ jobs.prepare.outputs.frameworks }}
      dry:
        value: ${{ jobs.prepare.outputs.dry }}

jobs:
  prepare:
    runs-on: macos-15

    env:
      LBL_BETA: cut-beta
      LBL_RC: cut-rc
      LBL_CAM: CameraSDK
      LBL_CORE: CoreSDK

    outputs:
      cut: ${{ steps.scope.outputs.cut }}
      frameworks: ${{ steps.scope.outputs.aff }}
      dry: ${{ steps.scope.outputs.dry }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: scope
        shell: bash
        run: |
          set -eo pipefail
          event_name="${{ inputs.event_name }}"
          labels="$(jq -r '.pull_request.labels[].name // empty' <<< '${{ inputs.event }}' 2>/dev/null || true)"

          # Determine cut type
          cut=""
          if [ "$event_name" = "workflow_dispatch" ] && [ -n "${{ inputs.cut }}" ]; then
            cut="${{ inputs.cut }}"
          else
            grep -qx "${LBL_BETA}" <<< "$labels" && cut="beta"
            grep -qx "${LBL_RC}" <<< "$labels" && cut="${cut:+$cut,}rc"
          fi

          # PR: prod not allowed automatically
          if [ "$event_name" = "pull_request" ]; then
            if [ -z "$cut" ] || [ "$cut" = "prod" ]; then
              echo "cut=" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          if [ -z "$cut" ]; then
            echo "cut=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Determine frameworks
          allow=""
          if [ "$event_name" = "workflow_dispatch" ] && [ -n "${{ inputs.frameworks }}" ]; then
            case "${{ inputs.frameworks }}" in
              camera) allow="cam" ;;
              core) allow="core" ;;
              all) allow="cam core" ;;
            esac
          else
            grep -qx "${LBL_CAM}" <<< "$labels" && allow="cam $allow"
            grep -qx "${LBL_CORE}" <<< "$labels" && allow="core $allow"
          fi

          allow="$(echo "$allow" | xargs)"

          echo "cut=$cut" >> $GITHUB_OUTPUT
          echo "aff=$allow" >> $GITHUB_OUTPUT
          echo "dry=${{ inputs.dry }}" >> $GITHUB_OUTPUT
