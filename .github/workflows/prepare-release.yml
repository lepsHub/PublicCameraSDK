name: Prepare Release

on:
  workflow_call:
    inputs:
      cut:
        type: string
        required: false
      frameworks:
        type: string
        required: false
      dry:
        type: string
        required: false
      event_name:
        type: string
        required: true
      event:
        type: string
        required: true
    outputs:
      cut:
        value: ${{ jobs.prepare.outputs.cut }}
      frameworks:
        value: ${{ jobs.prepare.outputs.frameworks }}
      dry:
        value: ${{ jobs.prepare.outputs.dry }}

permissions:
  contents: read

jobs:
  prepare:
    runs-on: macos-15

    env:
      LBL_BETA: cut-beta
      LBL_RC: cut-rc
      LBL_CAM: CameraSDK
      LBL_CORE: CoreSDK

    outputs:
      cut: ${{ steps.scope.outputs.cut }}
      frameworks: ${{ steps.scope.outputs.frameworks }}
      dry: ${{ steps.scope.outputs.dry }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: scope
        shell: bash
        run: |
          set -eo pipefail

          event_name="${{ inputs.event_name }}"
          event_json='${{ inputs.event }}'
          labels=$(jq -r '.pull_request.labels[].name // empty' <<< "$event_json" 2>/dev/null || true)

          # Determine CUT
          cut="${{ inputs.cut }}"

          if [ "$event_name" = "pull_request" ]; then
            if grep -qx "${LBL_BETA}" <<< "$labels"; then cut="beta"; fi
            if grep -qx "${LBL_RC}" <<< "$labels";   then cut="rc"; fi

            # PRs NEVER trigger prod
            if [ -z "$cut" ] || [ "$cut" = "prod" ]; then
              echo "cut=" >> $GITHUB_OUTPUT
              echo "frameworks=" >> $GITHUB_OUTPUT
              echo "dry=${{ inputs.dry }}" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          if [ -z "$cut" ]; then
            echo "cut=" >> $GITHUB_OUTPUT
            echo "frameworks=" >> $GITHUB_OUTPUT
            echo "dry=${{ inputs.dry }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Determine frameworks affected
          allow=""

          if [ "$event_name" = "workflow_dispatch" ] && [ -n "${{ inputs.frameworks }}" ]; then
            case "${{ inputs.frameworks }}" in
              camera) allow="cam" ;;
              core) allow="core" ;;
              all) allow="cam core" ;;
            esac
          else
            grep -qx "${LBL_CAM}" <<< "$labels"  && allow="$allow cam"
            grep -qx "${LBL_CORE}" <<< "$labels" && allow="$allow core"
          fi

          allow="$(echo "$allow" | xargs)"  # normalize spaces

          # Convert frameworks â†’ JSON array
          if [ -z "$allow" ]; then
            json_array="[]"
          else
            json_array=$(printf '%s\n' "$allow" | jq -R 'split(" ")')
          fi

          echo "cut=$cut" >> $GITHUB_OUTPUT
          echo "frameworks=$json_array" >> $GITHUB_OUTPUT
          echo "dry=${{ inputs.dry }}" >> $GITHUB_OUTPUT
