name: Cut Release Refactor

on:
  pull_request:
    types: [closed]
    branches:
      - 'release/*'
  workflow_dispatch:
    inputs:
      cut:
        description: "Release type"
        type: choice
        options: [beta, rc, prod]
        required: false
      frameworks:
        description: "Which SDK(s) to cut"
        type: choice
        options: [camera, core, all]
        required: false
      dry_run:
        description: "Preview only (no tag/release)"
        type: boolean
        default: false
        required: false

permissions:
  contents: write
  pull-requests: read

concurrency:
  group: cut-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  cut_release:
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true) ||
      (github.event_name == 'workflow_dispatch')
    runs-on: macos-15

    env:
      # Labels
      LBL_BETA: cut-beta
      LBL_RC: cut-rc
      LBL_PROD: cut-prod
      LBL_CAM: CameraSDK
      LBL_CORE: CoreSDK

      # Tag prefixes
      TAGPFX_CAM: 'CameraSDK'
      TAGPFX_CORE: 'CoreSDK'

      CHANNEL_PLIST_KEY: 'TRVReleaseChannel'

      # tokens (must be provided in repo secrets)
      GH_EXTERNAL_PAT: ${{ secrets.GH_EXTERNAL_PAT }}
      COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_EXTERNAL_PAT }}

      - name: Install tooling
        run: |
          brew update >/dev/null || true
          brew install jq xcodegen >/dev/null || true

      - name: Resolve scope (cut + aff)
        id: scope
        env:
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          EV_NAME: ${{ github.event_name }}
          EV_CUT: ${{ github.event.inputs.cut }}
          EV_FW: ${{ github.event.inputs.frameworks }}
          EV_DRY: ${{ github.event.inputs.dry_run }}
          LBL_BETA: ${{ env.LBL_BETA }}
          LBL_RC: ${{ env.LBL_RC }}
          LBL_PROD: ${{ env.LBL_PROD }}
          LBL_CAM: ${{ env.LBL_CAM }}
          LBL_CORE: ${{ env.LBL_CORE }}
        run: |
          mkdir -p .github/scripts
          chmod +x .github/scripts/*.sh
          curl -sSfL https://raw.githubusercontent.com/lepsHub/CoreSDK/main/.github/scripts/resolve_scope.sh -o .github/scripts/resolve_scope.sh || true
          # fallback to local script if present
          if [ -f "./scripts/resolve_scope.sh" ]; then
            ./scripts/resolve_scope.sh
          else
            bash .github/scripts/resolve_scope.sh
          fi
        shell: bash

      - name: Prepare environment for subsequent steps
        if: ${{ steps.scope.outputs.should_run == 'true' }}
        run: echo "Scope OK, continuing"

      - name: Generate Xcode project
        if: ${{ steps.scope.outputs.should_run == 'true' && steps.scope.outputs.aff != '' }}
        run: |
          set -eo pipefail
          make genbuild
          if [ -f "CoreSDK.xcodeproj/project.pbxproj" ]; then
            proj="CoreSDK.xcodeproj"
          else
            proj=$(ls -1 *.xcodeproj 2>/dev/null | head -n1 || true)
          fi
          if [ -z "$proj" ]; then
            echo "No .xcodeproj found after make genbuild"; exit 1
          fi
          echo "PROJECT=$proj" >> $GITHUB_ENV
          echo "Using PROJECT=$proj"

      - name: Compute versions, build, tag & release
        if: ${{ steps.scope.outputs.should_run == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GH_EXTERNAL_PAT }}
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
          CHANNEL_PLIST_KEY: ${{ env.CHANNEL_PLIST_KEY }}
          TAGPFX_CAM: ${{ env.TAGPFX_CAM }}
          TAGPFX_CORE: ${{ env.TAGPFX_CORE }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
          CUT: ${{ steps.scope.outputs.cut }}
          AFF: ${{ steps.scope.outputs.aff }}
          DRY: ${{ steps.scope.outputs.dry }}
        run: |
          set -eo pipefail
          mkdir -p .github/scripts
          chmod +x .github/scripts/*.sh
          curl -sSfL https://raw.githubusercontent.com/lepsHub/CoreSDK/main/.github/scripts/versioning.sh -o .github/scripts/versioning.sh || true
          curl -sSfL https://raw.githubusercontent.com/lepsHub/CoreSDK/main/.github/scripts/build.sh -o .github/scripts/build.sh || true
          curl -sSfL https://raw.githubusercontent.com/lepsHub/CoreSDK/main/.github/scripts/releases.sh -o .github/scripts/releases.sh || true
          curl -sSfL https://raw.githubusercontent.com/lepsHub/CoreSDK/main/.github/scripts/publish_package_repos.sh -o .github/scripts/publish_package_repos.sh || true

          # prefer local scripts if present
          if [ -f "./scripts/versioning.sh" ]; then
            ./scripts/versioning.sh
            ./scripts/build.sh
            ./scripts/releases.sh
            ./scripts/publish_package_repos.sh
          else
            bash .github/scripts/versioning.sh
            bash .github/scripts/build.sh
            bash .github/scripts/releases.sh
            bash .github/scripts/publish_package_repos.sh
          fi
        shell: bash
