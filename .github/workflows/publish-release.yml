name: Publish Release

on:
  workflow_call:
    inputs:
      cut:
        type: string
        required: true
      frameworks:
        type: string
        required: true
      dry:
        type: string
        required: false
        default: "false"

permissions:
  contents: write
  pull-requests: read

jobs:
  publish:
    runs-on: macos-15
    strategy:
      matrix:
        key: ${{ fromJson(inputs.frameworks) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure tools
        run: |
          brew update >/dev/null
          brew install jq >/dev/null || true
          if ! command -v unzip >/dev/null 2>&1; then
            brew install unzip >/dev/null || true
          fi

      - name: Load lib
        run: |
          chmod +x .github/scripts/release-lib.sh
          source .github/scripts/release-lib.sh

      - name: Set framework config
        id: set_framework_config
        run: |
          set -euo pipefail
          source .github/scripts/release-lib.sh

          # Validate matrix input
          if [ -z "${{ matrix.key }}" ]; then
            echo "ERROR: empty framework key in matrix"
            exit 1
          fi

          # Call framework_config and fail fast if unknown
          if ! framework_config "${{ matrix.key }}"; then
            echo "FATAL: framework_config failed for key='${{ matrix.key }}'"
            exit 1
          fi

          # Defensive sanity-checks
          : "${PREFIX:?FATAL: PREFIX is empty}"
          : "${SCHEME:?FATAL: SCHEME is empty}"
          : "${PATHS:?FATAL: PATHS is empty}"
          : "${VDIR:?FATAL: VDIR is empty}"

          # Export outputs for later steps
          echo "prefix=${PREFIX}" >> $GITHUB_OUTPUT
          echo "scheme=${SCHEME}" >> $GITHUB_OUTPUT
          echo "path=${PATHS}" >> $GITHUB_OUTPUT
          echo "vd=${VDIR}" >> $GITHUB_OUTPUT
          echo "external=${EXTERNAL_REPO}" >> $GITHUB_OUTPUT
          echo "podrepo=${POD_REPO}" >> $GITHUB_OUTPUT
          echo "podspec=${PODSPEC_NAME}" >> $GITHUB_OUTPUT
          echo "spm=${SPM_REPO}" >> $GITHUB_OUTPUT
          echo "binary=${BINARY_NAME}" >> $GITHUB_OUTPUT

      - name: Download artifact (XCFramework zip)
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.key }}-artifact
          path: build/

      - name: Validate XCFramework ZIP
        run: |
          set -euo pipefail
          source .github/scripts/release-lib.sh

          # Read scheme from the step outputs we just set
          SCHEME="${{ steps.set_framework_config.outputs.scheme }}"

          if [ -z "$SCHEME" ]; then
            echo "FATAL: scheme is empty (cannot locate zip)"
            exit 1
          fi

          ZIP="build/${SCHEME}.xcframework.zip"
          if [ ! -f "$ZIP" ]; then
            ZIP_CANDIDATE=$(ls build/*.xcframework.zip 2>/dev/null | head -n1 || true)
            if [ -n "$ZIP_CANDIDATE" ]; then
              ZIP="$ZIP_CANDIDATE"
            fi
          fi

          if [ ! -f "$ZIP" ]; then
            echo "FATAL: no xcframework zip found for scheme=${SCHEME}"
            ls -la build || true
            exit 1
          fi

          validate_xcframework_zip "$ZIP"
          cp "$ZIP" "/tmp/${{ matrix.key }}.xcframework.zip"

      - name: Compute checksum for SPM
        run: |
          set -euo pipefail
          source .github/scripts/release-lib.sh
          ZIP="/tmp/${{ matrix.key }}.xcframework.zip"
          if [ ! -f "$ZIP" ]; then
            echo "FATAL: checksum step: zip not found: $ZIP"
            exit 1
          fi
          CS=$(compute_checksum "$ZIP")
          echo "checksum=$CS" >> $GITHUB_OUTPUT

      - name: Prepare repo changes (Version.swift / Info.plist / Changelog)
        id: prepare
        run: |
          set -euo pipefail
          source .github/scripts/release-lib.sh

          PREFIX="${{ steps.set_framework_config.outputs.prefix }}"
          PATHS="${{ steps.set_framework_config.outputs.path }}"
          VDIR="${{ steps.set_framework_config.outputs.vd }}"

          if [ -z "$PREFIX" ] || [ -z "$PATHS" ] || [ -z "$VDIR" ]; then
            echo "FATAL: missing framework config outputs (prefix/path/vd)"
            exit 1
          fi

          # Determine last prod tag and base
          last_prod=$(git tag -l "${PREFIX}-*" --sort=-v:refname | grep -E "^${PREFIX}-[0-9]+\.[0-9]+\.[0-9]+$" | head -n1 || true)
          since_ref=""
          [ -n "$last_prod" ] && since_ref="$(git rev-list -n1 "$last_prod")"
          range="${since_ref:+${since_ref}..}HEAD"

          base=$(bump_from_commits "$last_prod" "${range:-HEAD}")
          buildnum=$(next_global_build_number "$PREFIX" "$base")
          full="${base}-BETA.${buildnum}"

          # Update plists under path
          plist_files=$(find_plists "$PATHS")
          if [ -z "$plist_files" ]; then
            echo "WARNING: no Info.plist files found under $PATHS"
          fi

          for f in $plist_files; do
            write_short_ver "$f" "$base"
            write_build_num "$f" "$buildnum"
            write_channel_key "$f" "BETA"
            git add "$f" || true
          done

          gen_version_swift "$VDIR" "$full" "BETA" "$buildnum"
          if [ -f "${VDIR}/Version.swift" ]; then
            git add "${VDIR}/Version.swift" || true
          fi

          gen_changelog_md "${range}" "$PATHS" > CHANGELOG.md || true
          git add CHANGELOG.md || true

          echo "full=$full" >> $GITHUB_OUTPUT
          echo "base=$base" >> $GITHUB_OUTPUT
          echo "buildnum=$buildnum" >> $GITHUB_OUTPUT
          echo "range=$range" >> $GITHUB_OUTPUT

      - name: Validate Podspec (in temporary podrepo clone)
        if: ${{ inputs.dry == 'false' }}
        run: |
          set -euo pipefail
          source .github/scripts/release-lib.sh

          POD_REPO="${{ steps.set_framework_config.outputs.podrepo }}"
          if [ -z "$POD_REPO" ]; then
            echo "FATAL: podrepo output empty"
            exit 1
          fi

          TMP=/tmp/podrepo-${{ matrix.key }}-$$
          rm -rf "$TMP" || true
          git clone "https://${{ secrets.GH_EXTERNAL_PAT }}@github.com/${POD_REPO}.git" "$TMP"
          safe_cd "$TMP"

          cp "/tmp/${{ matrix.key }}.xcframework.zip" . || true

          # Determine podspec path
          PODSPEC_PATH="${{ steps.set_framework_config.outputs.podspec }}"
          if [ -z "$PODSPEC_PATH" ]; then
            PODSPEC_PATH=$(ls *.podspec 2>/dev/null | head -n1 || true)
          fi

          if [ -z "$PODSPEC_PATH" ]; then
            log_err "No podspec found to lint in podrepo or source repo"
            exit 1
          fi

          log_step "Validating podspec: $PODSPEC_PATH"
          validate_podspec "$PODSPEC_PATH"

      - name: Validate SPM package (checksum + basic check)
        if: ${{ inputs.dry == 'false' }}
        run: |
          set -euo pipefail
          source .github/scripts/release-lib.sh
          ZIP="/tmp/${{ matrix.key }}.xcframework.zip"
          validate_spm_package "$ZIP" "/tmp/${{ matrix.key }}-spm-$$"

      - name: Commit changes (version bump / changelog)
        if: ${{ inputs.dry == 'false' }}
        run: |
          git commit -m "chore(release): bump ${{ matrix.key }} ${{ steps.prepare.outputs.full }}" || true
          git push

      - name: Create tag & push
        if: ${{ inputs.dry == 'false' }}
        run: |
          set -euo pipefail
          PREFIX="${{ steps.set_framework_config.outputs.prefix }}"
          FULL="${{ steps.prepare.outputs.full }}"

          if [ -z "$PREFIX" ] || [ -z "$FULL" ]; then
            echo "FATAL: cannot create tag, prefix or full empty"
            exit 1
          fi

          TAG="${PREFIX}-${FULL}"
          git tag "$TAG" || true
          git push origin "$TAG" || true

      - name: Publish to external repo (create release + upload zip)
        if: ${{ inputs.dry == 'false' }}
        run: |
          set -euo pipefail
          source .github/scripts/release-lib.sh

          EXTERNAL="${{ steps.set_framework_config.outputs.external }}"
          FULL="${{ steps.prepare.outputs.full }}"
          ZIP="/tmp/${{ matrix.key }}.xcframework.zip"

          if [ -z "$EXTERNAL" ] || [ -z "$FULL" ]; then
            echo "FATAL: publish external missing values"
            exit 1
          fi

          gh api -X POST "repos/${EXTERNAL}/releases" \
            -f tag_name="${FULL}" \
            -f name="${FULL}" \
            -f body="Release ${FULL}" \
            -F prerelease=true >/dev/null || true

          gh release upload "${FULL}" "$ZIP" --repo "${EXTERNAL}" || true

      - name: Update Pod Repo (push branch + tag + release)
        if: ${{ inputs.dry == 'false' }}
        run: |
          set -euo pipefail
          source .github/scripts/release-lib.sh

          POD_REPO="${{ steps.set_framework_config.outputs.podrepo }}"
          FULL="${{ steps.prepare.outputs.full }}"
          TMP="/tmp/pod-update-${{ matrix.key }}-$$"
          rm -rf "$TMP" || true
          git clone "https://${{ secrets.GH_EXTERNAL_PAT }}@github.com/${POD_REPO}.git" "$TMP"
          safe_cd "$TMP"
          cp "/tmp/${{ matrix.key }}.xcframework.zip" .
          if [ -f "../${{ steps.set_framework_config.outputs.podspec }}" ]; then
            cp "../${{ steps.set_framework_config.outputs.podspec }}" .
          fi
          if [ -f "${{ steps.set_framework_config.outputs.podspec }}" ]; then
            sed -i '' "s/spec.version *= *'.*'/spec.version = '$FULL'/" "${{ steps.set_framework_config.outputs.podspec }}" || true
          fi
          git checkout -b "$FULL" || git checkout "$FULL" || true
          git add .
          if ! git diff --cached --quiet; then git commit -m "Release $FULL"; fi
          git tag "$FULL" || true
          git push origin "refs/heads/$FULL:refs/heads/$FULL" || true
          git push origin "refs/tags/$FULL" || true
          gh api -X POST "repos/${POD_REPO}/releases" -f tag_name="$FULL" -f name="$FULL" -f body="Release $FULL" -F prerelease=true >/dev/null || true
          gh release upload "$FULL" "/tmp/${{ matrix.key }}.xcframework.zip" --repo "${POD_REPO}" || true

      - name: Update SPM Repo (Package.swift)
        if: ${{ inputs.dry == 'false' }}
        run: |
          set -euo pipefail
          source .github/scripts/release-lib.sh

          SPM_REPO="${{ steps.set_framework_config.outputs.spm }}"
          FULL="${{ steps.prepare.outputs.full }}"
          TMP="/tmp/spm-update-${{ matrix.key }}-$$"
          rm -rf "$TMP" || true
          git clone "https://${{ secrets.GH_EXTERNAL_PAT }}@github.com/${SPM_REPO}.git" "$TMP"
          safe_cd "$TMP"
          ZIPNAME="${FULL}-${{ matrix.key }}.xcframework.zip"
          cp "/tmp/${{ matrix.key }}.xcframework.zip" "./${ZIPNAME}"
          CHECKSUM=$(compute_checksum "./${ZIPNAME}")
          cat > Package.swift <<EOF
            // swift-tools-version:5.8
            import PackageDescription
            let package = Package(
            name: "${{ steps.set_framework_config.outputs.binary }}",
            products: [
                .library(name: "${{ steps.set_framework_config.outputs.binary }}", targets: ["${{ steps.set_framework_config.outputs.binary }}Targets"])
            ],
            targets: [
                .binaryTarget(
                name: "${{ steps.set_framework_config.outputs.binary }}",
                url: "https://github.com/${{ steps.set_framework_config.outputs.external }}/releases/download/${FULL}/${ZIPNAME}",
                checksum: "${CHECKSUM}"
                ),
                .target(name: "${{ steps.set_framework_config.outputs.binary }}Targets", dependencies: ["${{ steps.set_framework_config.outputs.binary }}"], path: "Sources")
            ]
            )
            EOF
          git checkout -b "$FULL" || git checkout "$FULL" || true
          git add Package.swift
          if ! git diff --cached --quiet; then git commit -m "SPM: Update Package.swift for $FULL"; fi
          git push origin "refs/heads/$FULL" || true
          git tag "$FULL" || true
          git push origin "refs/tags/$FULL" || true
          gh api -X POST "repos/${SPM_REPO}/releases" -f tag_name="$FULL" -f name="$FULL" -f body="Release $FULL" -F prerelease=true >/dev/null || true

      - name: Final log
        run: |
          log_step "Publish pipeline finished for ${{ matrix.key }} (dry=${{ inputs.dry }})"
