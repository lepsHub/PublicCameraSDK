name: Build SDKs

on:
  workflow_call:
    inputs:
      frameworks:
        type: string
        required: true

permissions:
  contents: read

jobs:
  build:
    runs-on: macos-15
    strategy:
      matrix:
        key: ${{ fromJson(inputs.frameworks) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Load script and config
        id: load
        run: |
          chmod +x .github/scripts/release-lib.sh
          source .github/scripts/release-lib.sh
          framework_config "${{ matrix.key }}"
          echo "scheme=${SCHEME}" >> $GITHUB_OUTPUT

      - name: Ensure tooling
        run: |
          brew update >/dev/null
          brew install jq xcodegen >/dev/null || true

      - name: Generate Xcode project (if needed)
        run: |
          if [ -f "Makefile" ]; then
            make genbuild || true
          fi

      - name: Archive iOS (device)
        run: |
          xcodebuild archive \
            -scheme "${{ steps.load.outputs.scheme }}" \
            -destination "generic/platform=iOS" \
            -archivePath "build/${{ steps.load.outputs.scheme }}/ios.xcarchive" \
            SKIP_INSTALL=NO BUILD_LIBRARY_FOR_DISTRIBUTION=YES

      - name: Archive Simulator
        run: |
          xcodebuild archive \
            -scheme "${{ steps.load.outputs.scheme }}" \
            -destination "generic/platform=iOS Simulator" \
            -archivePath "build/${{ steps.load.outputs.scheme }}/sim.xcarchive" \
            SKIP_INSTALL=NO BUILD_LIBRARY_FOR_DISTRIBUTION=YES

      - name: Create XCFramework
        run: |
          mkdir -p build/${{ steps.load.outputs.scheme }}
          xcodebuild -create-xcframework \
            -framework "build/${{ steps.load.outputs.scheme }}/ios.xcarchive/Products/Library/Frameworks/${{ steps.load.outputs.scheme }}.framework" \
            -framework "build/${{ steps.load.outputs.scheme }}/sim.xcarchive/Products/Library/Frameworks/${{ steps.load.outputs.scheme }}.framework" \
            -output "build/${{ steps.load.outputs.scheme }}.xcframework"

      - name: Pack XCFramework
        run: |
          zip -r "build/${{ steps.load.outputs.scheme }}.xcframework.zip" "build/${{ steps.load.outputs.scheme }}.xcframework"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.key }}-artifact
          path: build/*.xcframework.zip
